<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Unawakening: Return to the Island</title>
    <link rel="stylesheet" type="text/css" href="unawakening.css" title="Unawakening">

    <!--
      ____                             _____       _
     / __ \                           |  __ \     | |
    | |  | |_ __ __ _ _ __   __ _  ___| |__) |__ _| | _____   ___  _ __
    | |  | | '__/ _` | '_ \ / _` |/ _ \  _  // _` | |/ / _ \ / _ \| '_ \
    | |__| | | | (_| | | | | (_| |  __/ | \ \ (_| |   < (_) | (_) | | | |
     \____/|_|  \__,_|_| |_|\__, |\___|_|  \_\__,_|_|\_\___/ \___/|_| |_|.uk
    =========================__/ |==========================================
                            |___/  Author: Scott Hall   github: scotthall92
    -->

</head>
<body onload="init()">

<div>
<button onclick="resizeCanvas(1)">+</button>
<button onclick="resizeCanvas(-1)">-</button>
</div>

<p><canvas id="screenCanvas" width="192" height="144">Unsupported by browser</canvas></p>
<img id="tileset" src="tileset.png" width=0 height=0>
<img id="charset" src="charset.png" width=0 height=0>
<img id="player" src="player.png" width=0 height=0>

<script type="text/javascript">

var c = document.getElementById("screenCanvas");
var ctx = c.getContext("2d");
var scale = 2;

var fps = 60;
var mspf = 1000 / fps; // ms per frame

var tileset = document.getElementById("tileset");
var tsize = 12;

var charset = document.getElementById("charset");
var csize = 6;

var screenTileWidth = 8;
var screenTileHeight = 6;

var mapXCoord = 0;
var mapYCoord = 0;
var locale = [];

var player = document.getElementById("player");
var psize = 12;

var playerPosX = 0;
var playerPosY = 0;
var playerDirection = [0,0,1,0];  // +x,-x,+y,-y
var playerMoving = false;
var playerPushing = false;
var playerAnimationFrame = 1;
var playerAnimationBufferMax = 12;
var playerAnimationBuffer = 0;

var maxPosX = (tsize * screenTileWidth) - psize;
var maxPosY = (tsize * screenTileHeight) - psize;

var inputDelayBuffer = 0;

var transitionBufferMax = 6;
var transitionXBuffer = 0;
var transitionYBuffer = 0;
var transitionInputDelay = 6;

var portalBufferMax = 6;
var portalBuffer = 0;
var portalInputDelay = 6;

var dialogueBuffer = [];
var dialogueInputDelay = 6;
var dialogueFirstLine = "";
var dialogueSecondLine = "";

var keyMap = {};

function keydown(event) {
    keyMap[event.key] = true;
}

function keyup(event) {
    keyMap[event.key] = false;
}

document.onkeydown = keydown;
document.onkeyup = keyup;

var passableTiles = [
    "22","03","23","04","14","24","34","25","35","45","55","46","07","17","27","67",
    "77","08","18","28","68","78","88","98","09","19","29","69","79","89","99",
];

var portalTiles = ["21", "43", "53"];

var signpostTiles = ["44"];
var grassTiles = ["23"];

var outsideMap = {
    "00": "885967676723380158776767672339985867001013670338586701111303233858670377672323388957676723233799",
    "10": "110111011101110170808090626262007136369133533301713636849023238771363636911818037282828292181818",
    "20": "110111011101110110133141414151031113324242425218809033433343330318911334343434341884808080762275",
    "30": "110111011101110118626262181803180363536318181818180467040318181834340318709703007622758094181801",
    "40": "110111011101021218031818181301111818030010031300181823011123130110180323230300101118180303180111",
    "01": "495967676703390090001067672323019101021003672300849001021067001286910012116701023691010210670012",
    "11": "100010001018181811011101111803181000201018181818110121111800101810031818180111180210181818181818",
    "21": "188681818181228114031465240324182403246614032418140324242403241824240303031424342424242424241418",
    "31": "812281819618180034341313180318013431415113343434343040501334180034334333133403013434343434341800",
    "41": "101818182323001011184418232301113434343434136034101818181813601802102323231300101202102323001211",
    "02": "369100121167010236910111443423013691879018343434369118848080970336910354615434343691181867183400",
    "12": "121123232323181811314151231818183432425262180318343343335354232334343464232323181003343434343434",
    "22": "181818181818181818545454545454180354626262001023185433433301112318545434545454183434343418181818",
    "32": "181818181818180118133141511370801813304050137136031333533313713618181318131872821803181818232300",
    "42": "110111232301021090232323232301119123232323560010912323562356011192230010235600101000121123230111",
    "03": "369118183434340183921818340318009118877622759701911818033418180091181834341818018480762275808080",
    "13": "110318031818180310626231615123181163633242522318102323335333231811181818181803188080808080808080",
    "23": "181818181818181803708022902323231871464691232318237282829223181803182323231818038080808080808080",
    "33": "232323232323230123131313131323002313131313132301231313131313230023232323232323018080808080808090",
    "43": "110111442323001010440717274401111107790369172700100978441844280111130919191929007080902323232301",
    "04": "858181228181818191252525252525259125707622759725912571353555353591257135353535357380742626262626",
    "14": "818181818181818125626262051525252533533306162583352525253535557335353535453535352626262626262683",
    "24": "818181818181818125252525252525258293353535353583807435354535559135353545353535738293262626262626",
    "34": "818181818181819135353555353535919305153535051591710616353506169174353535353535842626262626262686",
    "44": "718191232303180071369162626223017136913353332300713684902323030194368684808080809636368681818181",
};

var maps = [outsideMap];

var mapIndex = 0;
var map = maps[mapIndex];

var characters = " ABCDEFGHIKKLMNOPQRSTUVWXYZ*abcdefghijklmnopqrstuvwxyz0123456789.,!?-':^>_<";

// Key is Map Index, Map X Coord, Map Y Coord, Tile x, Tile y (iXYxy)
var dialogues = {
    "unreadable": ["", "this angle!", "sign from", "read the", "You can't"],
    "00415": ["", "place:", "was a secret", "This cliff"],
    "01353": ["", "are closed:", "The curtains", ":Huh?"],
    "02132": ["", "move.", "heavy to", "It's too", ": :", ":"],
    "00241": ["", "    Village", " >  Bema", "    Woods", " ^  Endless"],
    "00244": ["", "pretty deep!", "It looks", "well:", "Well, well,"],
    "04121": ["", "roads!", "maintained", "our well-", "ourselves on", "- We pride", "Bema Village", "Welcome to"],
    "04330": ["", "", "Start _"],
    "04311": ["", "", "Finish!"],
    "04351": ["", "", "      <"],
    "04333": ["", "", "      >"],
    "04353": ["", "", "      ^"],
};

var portals = {
    "01422": {"mapIndex": 0, "mapX": 3, "mapY": 0, "x": 2, "y": 3},
    "03022": {"mapIndex": 0, "mapX": 1, "mapY": 4, "x": 2, "y": 3},
};

function resizeCanvas(increment) {
    scale = scale + increment;
    if (scale < 1) { scale = 1; }
    c.width = screenTileWidth * tsize * scale;
    c.height = screenTileHeight * tsize * scale;
    ctx.imageSmoothingEnabled = false;
    drawScreen();
}

function init() {
    ctx.imageSmoothingEnabled = false;
    updateLocale("22");
    mapXCoord = 2;
    mapYCoord = 2;
    playerPosX = 3 * tsize;
    playerPosY = 4 * tsize;

    update();
}

function update() {
    var start = Date.now();

    // Do stuff
    processKeys();
    drawScreen();

    var delta = Date.now() - start;
    var delay = mspf - delta;
    // console.info(delay);
    if (delay > 0) {
        setTimeout(update, delay);
    } else {
        update();
    }
}

function updateLocale(coords) {
    for (i = 0; i < screenTileWidth; i++) {
        locale[i] = [];
        for (j = 0; j < screenTileHeight; j++) {
            locale[i][j] = map[coords].slice(j*screenTileWidth*2 + i*2, j*screenTileWidth*2 + i*2 + 2)
        }
    }
}

function transitionScreen(xincrement, yincrement) {
    transitionXBuffer = 0;
    transitionYBuffer = 0;

    mapXCoord = mapXCoord + xincrement;
    mapYCoord = mapYCoord + yincrement;

    if (mapYCoord < 0) {
        mapYCoord = 0;
    }

    var coords = String(mapXCoord) + String(mapYCoord);
    updateLocale(coords);

    if (xincrement > 0) {
        playerPosX = 0;
    }
    if (xincrement < 0) {
        playerPosX = maxPosX;
    }
    if (yincrement > 0) {
        playerPosY = 0;
    }
    if (yincrement < 0) {
        playerPosY = maxPosY;
    }

    inputDelayBuffer = transitionInputDelay;
}

function enterPortal() {
    var xCoord = Math.floor((playerPosX + (psize - 1) * playerDirection[0]) / tsize) + playerDirection[0] - playerDirection[1];
    var yCoord = Math.floor((playerPosY + (psize - 1) * playerDirection[2]) / tsize) + playerDirection[2] - playerDirection[3];
    key = String(mapIndex) + String(mapXCoord) + String(mapYCoord) + String(xCoord) + String(yCoord);

    if (portals[key]) {
        portalBuffer = 0;
        transitionXBuffer = 0;
        transitionYBuffer = 0;

        map = maps[portals[key]["mapIndex"]];
        mapXCoord = portals[key]["mapX"];
        mapYCoord = portals[key]["mapY"];
        playerPosX = portals[key]["x"] * tsize;
        playerPosY = portals[key]["y"] * tsize;

        var coords = String(mapXCoord) + String(mapYCoord);
        updateLocale(coords);

        inputDelayBuffer = portalInputDelay;
    }
}

function drawScreen() {
    drawLocale();
    drawActors();
    drawDialogue();
}

function drawLocale() {
    for (i = 0; i < screenTileWidth; i++) {
        for (j = 0; j < screenTileHeight; j++) {
            var dx = i * tsize * scale;
            var dy = j * tsize * scale;
            var sx = parseInt(locale[i][j][0]) * tsize;
            var sy = parseInt(locale[i][j][1]) * tsize;
            ctx.drawImage(tileset, sx, sy, tsize, tsize, dx, dy, tsize * scale, tsize * scale);
        }
    }
}

function drawActors() {
    // Player
    if (playerMoving) {
        playerAnimationBuffer = playerAnimationBuffer + 1;
        if (playerAnimationBuffer == playerAnimationBufferMax) {
            playerAnimationFrame = Number(playerAnimationFrame == 0);
            playerAnimationBuffer = 0;
        }
    }

    var sx = 0;
    var sy = psize * playerAnimationFrame;
    if (playerDirection[0] == 1) {
        sx = 0;
    } else if (playerDirection[1] == 1) {
        sx = psize;
    } else if (playerDirection[2] == 1) {
        sx = psize * 2;
    } else if (playerDirection[3] == 1) {
        sx = psize * 3;
    }
    if (playerPushing) {
        sy = psize * 2;
    }
    ctx.drawImage(player, sx, sy, psize, psize, playerPosX * scale, playerPosY * scale, psize * scale, psize * scale);

    // Surface overlay
    var feetXCoord = Math.floor((playerPosX + (psize / 2)) / tsize);
    var feetYCoord = Math.floor((playerPosY + (psize - 1)) / tsize);
    if (grassTiles.indexOf(locale[feetXCoord][feetYCoord]) >= 0) {
        sx = psize * 4;
        sy = 0;
        ctx.drawImage(player, sx, sy, psize, psize, playerPosX * scale, playerPosY * scale, psize * scale, psize * scale);
    }
}

function drawDialogue() {
    if (dialogueBuffer.length > 0) {
        // Blank text box
        for (i = 1; i < (screenTileWidth * 2) - 1; i++) {
            for (j = 1; j < 6; j++) {
                var dx = i * csize * scale;
                var dy = j * csize * scale;
                ctx.drawImage(charset, 0, 0, csize, csize, dx, dy, csize * scale, csize * scale);
            }
        }

        // First line
        for (i = 0; i < dialogueFirstLine.length; i++) {
            var dx = ((2 * csize) + (i * csize)) * scale;
            var dy = 2 * csize * scale;
            var sx = (characters.indexOf(dialogueFirstLine[i]) % 27) * csize;
            var sy = Math.floor(characters.indexOf(dialogueFirstLine[i]) / 27) * csize;
            ctx.drawImage(charset, sx, sy, csize, csize, dx, dy, csize * scale, csize * scale);
        }

        // Second line
        for (i = 0; i < dialogueSecondLine.length; i++) {
            var dx = ((2 * csize) + (i * csize)) * scale;
            var dy = 4 * csize * scale;
            var sx = (characters.indexOf(dialogueSecondLine[i]) % 27) * csize;
            var sy = Math.floor(characters.indexOf(dialogueSecondLine[i]) / 27) * csize;
            ctx.drawImage(charset, sx, sy, csize, csize, dx, dy, csize * scale, csize * scale);
        }

        // "Read more" prompt
        if (dialogueBuffer.length > 1) {
            var dx = ((screenTileWidth * 2) - 2) * csize * scale;
            var dy = 5 * csize * scale;
            ctx.drawImage(charset, 0, csize, csize, csize, dx, dy, csize * scale, csize * scale);
        }
    }
}

function playerStep(collinearAxis) {
    playerMoving = true;
    playerPushing = false;

    if (collinearAxis == "x") {
        var collinearPos = playerPosX;
        var orthogonalPos = playerPosY;
        var maxCollinearPos = maxPosX;
        var positiveCollinearDirection = playerDirection[0];
        var negativeCollinearDirection = playerDirection[1];
        var collinearTransitionBuffer = transitionXBuffer;
        var screenTileMax = screenTileWidth;
    } else if (collinearAxis == "y") {
        var collinearPos = playerPosY;
        var orthogonalPos = playerPosX;
        var maxCollinearPos = maxPosY;
        var positiveCollinearDirection = playerDirection[2];
        var negativeCollinearDirection = playerDirection[3];
        var collinearTransitionBuffer = transitionYBuffer;
        var screenTileMax = screenTileHeight;
    } else {
        throw "Collinear axis must be 'x' or 'y'";
    }

    var newCollinearPos = collinearPos + positiveCollinearDirection - negativeCollinearDirection;
    var newOrthogonalPos = orthogonalPos;

    var collinearCoord = Math.floor((newCollinearPos + (psize - 1) * positiveCollinearDirection) / tsize);

    if ((collinearCoord >= 0) && (collinearCoord < screenTileMax)) {
        var start = Math.floor(orthogonalPos / tsize);
        var end = Math.floor((orthogonalPos + psize - 1) / tsize);
        var start1 = Math.floor((orthogonalPos + 1) / tsize);
        var end1 = Math.floor((orthogonalPos + psize - 2) / tsize);
        var start2 = Math.floor((orthogonalPos + 2) / tsize);
        var end2 = Math.floor((orthogonalPos + psize - 3) / tsize);
        if (collinearAxis == "x") {
            var startTile = locale[collinearCoord][start];
            var endTile = locale[collinearCoord][end];
            var start1Tile = locale[collinearCoord][start1];
            var end1Tile = locale[collinearCoord][end1];
            var start2Tile = locale[collinearCoord][start2];
            var end2Tile = locale[collinearCoord][end2];
        } else if (collinearAxis == "y") {
            var startTile = locale[start][collinearCoord];
            var endTile = locale[end][collinearCoord];
            var start1Tile = locale[start1][collinearCoord];
            var end1Tile = locale[end1][collinearCoord];
            var start2Tile = locale[start2][collinearCoord];
            var end2Tile = locale[end2][collinearCoord];
        }

        var passableStart = passableTiles.indexOf(startTile) >= 0;
        var passableEnd = passableTiles.indexOf(endTile) >= 0;
        if (!passableStart && !passableEnd) {
            newCollinearPos = collinearPos;
            playerPushing = true;
        } else if (passableStart && !passableEnd) {
            // Check for bump around corner
            if (passableTiles.indexOf(end1Tile) >= 0) {
                newOrthogonalPos = orthogonalPos - 1;
            } else if (passableTiles.indexOf(end2Tile) >= 0) {
                newOrthogonalPos = orthogonalPos - 1;
                newCollinearPos = collinearPos;
            } else {
                newCollinearPos = collinearPos;
                playerPushing = true;
            }
        } else if (!passableStart && passableEnd) {
            // Check for bump around corner
            if (passableTiles.indexOf(start1Tile) >= 0) {
                newOrthogonalPos = orthogonalPos + 1;
            } else if (passableTiles.indexOf(start2Tile) >= 0) {
                newOrthogonalPos = orthogonalPos + 1;
                newCollinearPos = collinearPos;
            } else {
                newCollinearPos = collinearPos;
                playerPushing = true;
            }
        }

        var portalStart = portalTiles.indexOf(startTile) >= 0;
        var portalEnd = portalTiles.indexOf(endTile) >= 0;
        if (portalStart && portalEnd) {
            portalBuffer = portalBuffer + 1;
        } else if (portalStart && !portalEnd) {
            if (portalTiles.indexOf(end2Tile) >= 0) {
                newOrthogonalPos = orthogonalPos - 1;
            }
        } else if (!portalStart && portalEnd) {
            if (portalTiles.indexOf(start2Tile) >= 0) {
                newOrthogonalPos = orthogonalPos + 1;
            }
        } else {
            portalBuffer = 0;
        }
    }

    // Edge of screen
    var newCollinearTransitionBuffer = 0;
    if (newCollinearPos < 0) {
        newCollinearPos = collinearPos;
        newCollinearTransitionBuffer = collinearTransitionBuffer - 1;
    } else if (newCollinearPos >= maxCollinearPos) {
        newCollinearPos = maxCollinearPos;
        newCollinearTransitionBuffer = collinearTransitionBuffer + 1;
    }

    if (collinearAxis == "x") {
        playerPosX = newCollinearPos;
        playerPosY = newOrthogonalPos;
        transitionXBuffer = newCollinearTransitionBuffer;
    } else if (collinearAxis == "y") {
        playerPosY = newCollinearPos;
        playerPosX = newOrthogonalPos;
        transitionYBuffer = newCollinearTransitionBuffer;
    }
}

function processKeys() {
    playerMoving = false;
    playerPushing = false;

    if (inputDelayBuffer > 0) {
        inputDelayBuffer = inputDelayBuffer - 1;
        return;
    }

    // Dialogue overrides other input
    if (dialogueBuffer.length > 0) {
        if (keyMap["j"]) {
            dialogueFirstLine = dialogueSecondLine;
            dialogueSecondLine = dialogueBuffer.pop();
            inputDelayBuffer = dialogueInputDelay;
        }
        return;
    }

    // Interact
    if (keyMap["j"]) {
        keyMap["j"] = false;

        var hpsize = psize / 2;
        var x = Math.floor((playerPosX + hpsize + (playerDirection[0] * hpsize) - (playerDirection[1] * hpsize) - playerDirection[1]) / tsize);
        var y = Math.floor((playerPosY + hpsize + (playerDirection[2] * hpsize) - (playerDirection[3] * hpsize) - playerDirection[3]) / tsize);
        var key = String(mapIndex) + String(mapXCoord) + String(mapYCoord) + String(x) + String(y);

        console.info(key);

        if (dialogues[key]) {
            dialogueBuffer = dialogues[key].slice();

            if ((signpostTiles.indexOf(locale[x][y]) >= 0) && (playerDirection[3] == 0)) {
                dialogueBuffer = dialogues["unreadable"].slice();
            }

            dialogueFirstLine = dialogueBuffer.pop();
            dialogueSecondLine = dialogueBuffer.pop();
            inputDelayBuffer = dialogueInputDelay;
            return;
        }
    }

    if (keyMap["w"]) {
        playerDirection = [0,0,0,1];
        playerStep("y");
        if (transitionYBuffer < -transitionBufferMax) {
            transitionScreen(0, -1);
            return;
        }
        if (portalBuffer > portalBufferMax) {
            enterPortal();
            return;
        }
    }
    if (keyMap["s"]) {
        playerDirection = [0,0,1,0];
        playerStep("y");
        if (transitionYBuffer > transitionBufferMax) {
            transitionScreen(0, 1);
            return;
        }
        if (portalBuffer > portalBufferMax) {
            enterPortal();
            return;
        }
    }
    if (keyMap["a"]) {
        playerDirection = [0,1,0,0];
        playerStep("x");
        if (transitionXBuffer < -transitionBufferMax) {
            transitionScreen(-1, 0);
            return;
        }
        if (portalBuffer > portalBufferMax) {
            enterPortal();
            return;
        }
    }
    if (keyMap["d"]) {
        playerDirection = [1,0,0,0];
        playerStep("x");
        if (transitionXBuffer > transitionBufferMax) {
            transitionScreen(1, 0);
            return;
        }
        if (portalBuffer > portalBufferMax) {
            enterPortal();
            return;
        }
    }
}

</script>

</body>
</html>

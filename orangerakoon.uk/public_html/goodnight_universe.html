<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Goodnight Universe</title>
    <link rel="stylesheet" type="text/css" href="goodnight_universe.css" title="Goodnight Universe">

    <!--
      ____                             _____       _
     / __ \                           |  __ \     | |
    | |  | |_ __ __ _ _ __   __ _  ___| |__) |__ _| | _____   ___  _ __
    | |  | | '__/ _` | '_ \ / _` |/ _ \  _  // _` | |/ / _ \ / _ \| '_ \
    | |__| | | | (_| | | | | (_| |  __/ | \ \ (_| |   < (_) | (_) | | | |
     \____/|_|  \__,_|_| |_|\__, |\___|_|  \_\__,_|_|\_\___/ \___/|_| |_|.uk
    =========================__/ |==========================================
                            |___/  Author: Scott Hall   github: scotthall92
    -->

</head>
<body>

<table>
  <tr>
    <td></td>
    <td class="middle" onclick="moveForward()">Forward (w)</td>
    <td></td>
  </tr>
  <tr>
    <td class="left" onclick="turnLeft()">Left (a)</td>
    <td class="middle" onclick="ping()">Ping (s)</td>
    <td class="right" onclick="turnRight()">Right (d)</td>
  </tr>
</table>

<div id="introDiv"><p>It is the far distant future. Humankind, or that which came after, once spread amongst the stars. Those stars have long since dwindled, and the last light has faded. The inevitable and eventual heat death of the universe approaches.</p>

<p>You find yourself drifting alone in this omnipresent darkness. With no light, and limited energy, your only hope of survival is to siphon what little power remains from long abandoned ships and deep space probes.</p>

<p>You have discovered that a few of these objects still respond to your broadcasts. By listening to their faint reply you should be able to pinpoint their location. With some luck you might even reach them before you lose all power yourself.</p>

<button type="button" onclick="beginGame()">Begin</button></div>

<script type="text/javascript">

/* LEVEL CREATION AND GENERATION */

function getRandomCoord() {
  return Math.floor(Math.random() * levels[level].size);
}

function getRandomCoords() {
  return { x: getRandomCoord(), y: getRandomCoord() }
}

function getUniqueRandomCoords(occupied) {
  while (true) {
    var coords = getRandomCoords();
    var unique = true;
    for (i = 0; i < occupied.length; i++) {
      if ((coords.x == occupied[i].x) && (coords.y == occupied[i].y)) {
        unique = false;
      }
    }
    if (unique) {
      return coords
    }
  }
}

function beginGame() {
  document.getElementById('introDiv').remove();
  startNextLevel();
}

function restartGame() {
  location.reload();
}

function startNextLevel() {
  level += 1;

  document.title = 'Goodnight Universe - Level ' + level;

  probes = [];
  for (i = 0; i < levels[level].probes; i++) {
    probes[i] = getUniqueRandomCoords(probes);
  }

  coords = getUniqueRandomCoords(probes);

  setTimeout(function(){
    beep(notes.a4, 220);
  }, 0)
  setTimeout(function(){
    beep(notes.c5, 220);
  }, 220)
  setTimeout(function(){
    beep(notes.f5, 220);
  }, 440)

  if (level > 10) {
    restartGame();
  }
}

/* GAME METHODS */

function getDistanceTo(target) {
  var x = coords.x - target.x;
  var y = coords.y - target.y;
  return Math.sqrt(x*x + y*y)
}

function beep(frequency, duration) {
  var oscillator = audioCtx.createOscillator();

  oscillator.type = 'sine';
  oscillator.frequency.value = frequency;
  oscillator.connect(audioCtx.destination);
  oscillator.start();

  setTimeout(function() { oscillator.stop(); }, duration);
}

/* INPUT METHODS */

// Right = +1, Left = -1
function turn(direction) {
  var xNew = 0;
  var yNew = 0;

  if (aim.x) {
    yNew = -aim.x * direction;
  }
  if (aim.y) {
    xNew = aim.y * direction;
  }

  aim = { x: xNew, y: yNew };
}

function turnLeft() {
  turn(-1);
}

function turnRight() {
  turn(1);
}

function moveForward() {
  if (aim.x) {
    coords.x += aim.x;
  }
  if (aim.y) {
    coords.y += aim.y;
  }
}

function ping() {
  // Send broadcast
  beep(notes.a4, 220);

  // Receive replies
  var forRemoval = false;
  for (i = 0; i < probes.length; i++) {
    var distance = getDistanceTo(probes[i])
    var delay = distance * 200;

    if (distance == 0) {
      forRemoval = { index: i };
      setTimeout(function(){
        beep(notes.a5, 220);
      }, delay);
    } else if (distance < 2) {
      setTimeout(function(){
        beep(notes.g5, 220);
      }, delay);
    } else if (distance < 4) {
      setTimeout(function(){
        beep(notes.f5, 220);
      }, delay);
    } else if (distance < 8) {
      setTimeout(function(){
        beep(notes.e5, 220);
      }, delay);
    } else if (distance < 16) {
      setTimeout(function(){
        beep(notes.d5, 220);
      }, delay);
    } else if (distance < 32) {
      setTimeout(function(){
        beep(notes.c5, 220);
      }, delay);
    } else if (distance < 64) {
      setTimeout(function(){
        beep(notes.b4, 220);
      }, delay);
    } else if (distance < 128) {
      setTimeout(function(){
        beep(notes.a4, 220);
      }, delay);
    } else {
      setTimeout(function(){
        beep(notes.g4, 220);
      }, delay);
    }
  }

  // Remove probes
  if (forRemoval) {
    probes.splice(forRemoval.index, 1);
  }

  // Check for level completion
  if (probes.length == 0) {
    startNextLevel();
  }
}

/* GLOBAL VARIABLES */

var audioCtx = new window.AudioContext;

// http://pages.mtu.edu/~suits/notefreqs.html
var notes = {
  g4: 392.00,
  a4: 440.00,
  b4: 493.88,
  c5: 523.25,
  d5: 587.33,
  e5: 659.25,
  f5: 698.46,
  g5: 783.99,
  a5: 880.00,
};

var levels = [
  { probes: 0, size: 0 },
  { probes: 1, size: 5 },
  { probes: 1, size: 7 },
  { probes: 1, size: 10 },
  { probes: 3, size: 15 },
  { probes: 3, size: 20 },
  { probes: 3, size: 30 },
  { probes: 5, size: 30 },
  { probes: 5, size: 40 },
  { probes: 5, size: 50 },
  { probes: 10, size: 100 },
  { probes: 0, size: 0 },
]

var level = 0;
probes = [];

var coords = { x: 2, y: 2};
var aim = { x: 1, y: 0 };

document.addEventListener("keypress", function onPress(event) {
  switch (event.key) {
    case "ArrowUp":
    case "w":
      moveForward();
      break;
    case "ArrowDown":
    case "s":
      ping();
      break;
    case "ArrowLeft":
    case "a":
      turnLeft();
      break;
    case "ArrowRight":
    case "d":
      turnRight();
      break;
    default:
      return;
  }
});

</script>

</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>RHYTHMURL</title>
    <link rel="stylesheet" type="text/css" href="rhythmurl.css">

    <!--
      ____                             _____       _
     / __ \                           |  __ \     | |
    | |  | |_ __ __ _ _ __   __ _  ___| |__) |__ _| | _____   ___  _ __
    | |  | | '__/ _` | '_ \ / _` |/ _ \  _  // _` | |/ / _ \ / _ \| '_ \
    | |__| | | | (_| | | | | (_| |  __/ | \ \ (_| |   < (_) | (_) | | | |
     \____/|_|  \__,_|_| |_|\__, |\___|_|  \_\__,_|_|\_\___/ \___/|_| |_|.uk
    =========================__/ |==========================================
                            |___/  Author: Scott Hall   github: scotthall92
    -->

</head>
<body>

<div class="center">
<noscript><h2>* This page requires JavaScript *</h2></noscript>
<p>RHYTHMURL is a rhythm game in your browser's address bar!</p>

<p>Use wasd to keep the beat. Maintain your combo to raise your multiplier.</p>

<p>Earn the highest score you can in 2 minutes.</p>
</div>

<p class='attribution'><a href='/'><<< back to orangerakoon.uk</a></p>

<script type="text/javascript">

function tick() {
  frameCount += 1;
  playBeat();
  processKeyPress();
  advanceState();
  buildFrame();
  setTimeout(tick, 200);
}

function decreaseScore(x) {
  score -= x;
  combo = 0;
  multiplier = 1;
}

function increaseScore(x) {
  score += x * multiplier;
  combo += 1;
  if (combo >= 50) {
    multiplier = 10;
  } else if (combo >= 20) {
    multiplier = 5;
  } else if (combo >= 10) {
    multiplier = 3;
  } else if (combo >= 5) {
    multiplier = 2;
  }
}

function processKeyPress() {
  if (keyPressed) {
    if (keyPressed == state[1]) {
      rating = 'OKAY';
      increaseScore(1);
      state = state.slice(0,1) + '_' + state.slice(2);
    } else if (keyPressed == state[2]) {
      rating = 'GOOD';
      increaseScore(2);
      state = state.slice(0,2) + '_' + state.slice(3);
    } else if (keyPressed == state[3]) {
      rating = 'OKAY';
      increaseScore(1);
      state = state.slice(0,3) + '_' + state.slice(4);
    } else {
      rating = 'MISS';
      decreaseScore(1);
    }
  }
  keyPressed = false;
}

// Returns a random integer between min (included) and max (excluded)
function getRandomInt(min, max) {
  return Math.floor(Math.random() * (max - min)) + min;
}

function advanceState() {
  if (state[0] != '_') {
    rating = 'MISS';
    decreaseScore(1);
  }
  if (frameCount > 600) {
    state = state.slice(1) + '_';
  } else {
    state = state.slice(1) + '____________________wasd'[getRandomInt(0, 24)];
  }
}

function assembleScore() {
  var sign = (score < 0) ? '-' : '+';
  var absScore = (Math.abs(score) > 9999) ? 9999 : Math.abs(score);
  return '[' + sign + ("0000" + absScore).slice(-4) + ']';
}

function buildFrame() {
  var display = state[0] + '[' + state[2] + ']' + state.slice(4);
  var scoreDisplay = assembleScore() + '[x' + multiplier + ']';
  location.hash = '#[' + rating + ']' + display + scoreDisplay;
}

function beep(frequency) {
  var oscillator = audioCtx.createOscillator();

  oscillator.type = 'square';
  oscillator.frequency.value = frequency;
  oscillator.connect(audioCtx.destination);
  oscillator.start();

  setTimeout(function() { oscillator.stop(); }, 200);
}

function beat(frequency) {
  var oscillator = audioCtx.createOscillator();

  oscillator.type = 'sawtooth';
  oscillator.frequency.value = frequency;
  oscillator.connect(gainNode);
  oscillator.start();

  setTimeout(function() { oscillator.stop(); }, 100);
}

function playBeat() {
  if (frameCount > 624) {
    return;
  } else if (frameCount == 624) {
    beat(notes.g3);
    return;
  }

  if (!(frameCount % 16)) {
    beat(notes.d4);
  } else if (!(frameCount % 4)) {
    beat(notes.b3);
  } else {
    beat(notes.g3);
  }
}

// Sound setup
var audioCtx = new window.AudioContext;
var gainNode = audioCtx.createGain()
gainNode.gain.value = 0.1 // 10 %
gainNode.connect(audioCtx.destination);
var notes = { // http://pages.mtu.edu/~suits/notefreqs.html
  g3: 196.00,
  b3: 246.94,
  d4: 293.66,
  g4: 392.00,
  b4: 493.88,
  d5: 587.33,
  g5: 783.99,
};

var frameCount = 0;
var keyPressed = false;
var score = 0;
var combo = 0;
var multiplier = 1;
var state = '____________________';
var rating = 'OKAY';

buildFrame();
setTimeout(tick, 200);

document.addEventListener("keypress", function onPress(event) {
  switch (event.key) {
    case "ArrowUp":
    case "w":
      keyPressed = 'w';
      beep(notes.g5);
      break;
    case "ArrowDown":
    case "s":
      keyPressed = 's';
      beep(notes.g4);
      break;
    case "ArrowLeft":
    case "a":
      keyPressed = 'a';
      beep(notes.d5);
      break;
    case "ArrowRight":
    case "d":
      keyPressed = 'd';
      beep(notes.b4);
      break;
    default:
      return;
  }
});

</script>

</body>
</html>

<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <title>Is Weather Happening?</title>
    <link rel="stylesheet" type="text/css" href="weather.css">

    <!--
      ____                             _____       _
     / __ \                           |  __ \     | |
    | |  | |_ __ __ _ _ __   __ _  ___| |__) |__ _| | _____   ___  _ __
    | |  | | '__/ _` | '_ \ / _` |/ _ \  _  // _` | |/ / _ \ / _ \| '_ \
    | |__| | | | (_| | | | | (_| |  __/ | \ \ (_| |   < (_) | (_) | | | |
     \____/|_|  \__,_|_| |_|\__, |\___|_|  \_\__,_|_|\_\___/ \___/|_| |_|.uk
    =========================__/ |==========================================
                            |___/  Author: Scott Hall   github: scotthall92
    -->
</head>

<body>

<div class="center"><div id="text" class="text"></div><br/><div id="value" class="value"></div></div>

<noscript><div class="center">Please enable JavaScript for Weather.</div></noscript>

<p class='attribution'><a href='/'><<< back to orangerakoon.uk</a></p>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="geoPosition.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript">
    var result = false;
    var weatherValue = "";

    var happeningNumbers = [
        200, 201, 202, 210, 211,
        212, 221, 230, 231, 232,
        502, 503, 504, 511, 522,
        600, 601, 602, 615, 616,
        620, 621, 622, 711, 721,
        731, 741, 751, 761, 762,
        771, 781, 900, 901, 902,
        905, 906, 957, 958, 959,
        960, 961, 962
    ];

    var loadingTextList = [
        "Launching Weather rockets...",
        "Contacting Weather agents...",
        "Infiltrating Weather HQ...",
        "Deploying Weather automatons...",
        "Reticulating Weather splines...",
        "Activating Weather machines...",
        "Releasing Weather hounds..."
    ];

    // Only grab elements once for efficiency
    textElement = document.getElementById('text');
    valueElement = document.getElementById('value');

    function loadingLoop() {
        textElement.innerHTML = loadingTextList[Math.floor(Math.random()*loadingTextList.length)];
        if (result) {
            textElement.innerHTML = result;
            valueElement.innerHTML = weatherValue;
        }
        else {
            setTimeout(loadingLoop, 2000);
        }
    }

    loadingLoop();

    if (geoPosition.init()) {  // Geolocation Initialisation
        geoPosition.getCurrentPosition(success_callback, error_callback);
    }
    else {
        result = "Sorry, your device doesn't appear to support location detection. No weather for you!"
    }

    // p : geolocation object
    function success_callback(p){
        // p.latitude : latitude value
        // p.longitude : longitude value
        $.ajax({
            type: "GET",
            url: "https://api.openweathermap.org/data/2.5/weather?lat=" + p.coords.latitude + "&lon=" + p.coords.longitude + "&mode=xml&APPID=782fc570d580c0d6b65690b70906a88c",
            dataType: "xml",
            success: function(xml) {
                weatherNumber = $(xml).find("weather").attr("number");
                weatherValue = $(xml).find("weather").attr("value");
                weatherNumber = parseInt(weatherNumber);
                if (happeningNumbers.indexOf(weatherNumber) > -1) {
                    textElement.innerHTML = "";
                    textElement.style.fontSize = "400%";
                    result = "Weather is happening!";
                }
                else {
                    textElement.innerHTML = "";
                    textElement.style.fontSize = "400%";
                    result = "No weather happening";
                }
            },
            error: function(xhr, status, error) {
                result = "Weather has encountered a problem and needs to close.";
            }
        });
    }

    function error_callback(p){
        // p.message : error message
        result = "Sorry, we couldn't locate you on our weather location scanners.";
    }

</script>

</body>
</html>
